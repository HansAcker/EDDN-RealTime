import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";const c=(e,t)=>Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2]),d=e=>{var t=document.createElement("td");return t.textContent=t.title=e,t};function m(e,t){for(;e.childElementCount>=listLength;)e.lastElementChild.remove();e.prepend(t)}const n={ok:"img/led/led-circle-green.svg",off:"img/led/led-circle-red.svg",idle:"img/led/led-circle-grey.svg",error:"img/led/led-circle-yellow.svg"};let o=null,a="off";const s=p.bind(null,"idle",0);function p(e,t=0){o&&(clearTimeout(o),o=null),a!=e&&(console.log(a+" => "+e),icon.href=n[e],a=e),t&&(o=setTimeout(s,t))}const u={Total:0,Old:0,New:0,Ignored:0,Taxi:0,Base:0,Horizons:0,Odyssey:0,Legacy:0,Unknown:0,TS:"","Max jump range":""};let y=0,l=statstable.querySelector("tbody"),g;function S(){var e=document.createElement("tbody");for(const n in u){var t=document.createElement("tr");t.append(d(n),d(u[n])),e.append(t)}l.replaceWith(e),l=e}let v=Date.now();const r=new e(socketUrl);r.onopen=p.bind(null,"idle",0),r.onclose=p.bind(null,"off",0),r.onmessage=e=>{let t={};try{t=JSON.parse(e.data)}catch(e){return console.log("JSON parse error:",e),void p("error")}if(e=t.message){p("ok",idleTimeout),v=Date.now(),u.Total++;var o=function(e){try{var t,n=e.header.gameversion;return n&&(n.startsWith("CAPI-Legacy-")||parseInt(n)<4)?"Legacy":(t=e.message).odyssey?"Odyssey":t.horizons?"Horizons":!1===t.horizons?"Base":"Unknown"}catch(e){return console.log("gameversion error:",e),"Unknown"}}(t),a=(u[o]++,document.createElement("tr"));a.classList.add(o),e.Taxi&&(u.Taxi++,a.classList.add("taxi")),u.TS=e.timestamp;try{36e5<(n=new Date-new Date(e.timestamp))?(a.classList.add("old"),u.Old++):n<-18e4&&(a.classList.add("new"),u.New++)}catch(e){console.log("Invalid date:",e)}if(e.event)if(e.event in u||(u[e.event]=0),u[e.event]++,"Scan"===e.event){if(a.append(d(e.BodyName),d(e.ScanType)),m(scanbods,a),!1===e.WasDiscovered&&"NavBeaconDetail"!==e.ScanType)if(e.StarType){const a=document.createElement("tr");a.classList.add(o),a.append(d(e.BodyName),d(e.StarType+" "+e.Subclass)),m(newstars,a)}else if(e.PlanetClass){const a=document.createElement("tr");a.classList.add(o),a.append(d(e.BodyName),d(e.PlanetClass),d(e.AtmosphereType&&"None"!==e.AtmosphereType?e.AtmosphereType:""),d(e.Landable?"Yes":"")),m(newplanets,a)}}else if("FSDJump"===e.event){if(a.append(d(e.StarSystem)),m(jumps,a),0<e.Population||e.SystemAllegiance){const a=document.createElement("tr");a.classList.add(o);var n=e.SystemFaction||{};a.append(d(e.StarSystem),d(1e9<=e.Population?(e.Population/1e9).toFixed(2)+"G":1e6<=e.Population?(e.Population/1e6).toFixed(2)+"M":1e3<=e.Population?(e.Population/1e3).toFixed(2)+"k":0<e.Population?(+e.Population).toFixed(2):""),d(e.SystemAllegiance),d(n.Name||""),d(n.FactionState||"")),m(visits,a)}}else if("NavRoute"===e.event)if(1<(o=e.Route||[]).length){a.append(d(o[0].StarSystem),d(o[o.length-1].StarSystem),d(o.length-1+"j"));try{let e=0,t=0,n=o.shift().StarPos;a.append(d(c(n,o[o.length-1].StarPos).toFixed(2)+"ly"));for(const i of o){var s=i.StarPos,l=c(n,s);y<l&&(y=l,u["Max jump range"]=l.toFixed(2)+"ly"),t<l&&(t=l),e+=l,n=s}a.append(d(1<o.length?e.toFixed(2)+"ly":""));var r=d(t.toFixed(2)+"ly");200<=t&&r.classList.add("longjump"),a.append(r)}catch(e){console.log("Error in route:",e)}m(routes,a)}else console.log("Short NavRoute:",t);else"Docked"===e.event||"Location"===e.event?(a.append(d(e.StationName||""),d(e.StationType||""),d(e.StarSystem)),m(docks,a)):"ApproachSettlement"===e.event?(a.append(d(e.Name),d(e.StarSystem)),m(asett,a)):"CodexEntry"===e.event?(a.append(d(e.System),d((n=e.BodyName||"",o=e.System,(n.startsWith(o)?n.slice(o.length):n).trim())),d(e.SubCategory),d(e.Name)),m(codex,a)):u.Ignored++;else a.append(d(e.commodities?"Market":e.ships?"Shipyard":e.modules?"Outfitting":""),d(e.stationName),d(e.systemName)),m(updates,a);document.hidden||(cancelAnimationFrame(g),g=requestAnimationFrame(S))}else console.log("No message: ",t),p("error")},function e(){r.readyState===WebSocket.OPEN&&Date.now()-v>resetTimeout&&(console.log("Receive timeout. Resetting connection."),r.refresh());var t=~~(6e4+42e3*Math.random());setTimeout(e,t)}();
