import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";import{ActivityIcon as o}from"./activity_icon.min.js";import{StatsBox as t}from"./statsbox.min.js";import{InfoBox as n}from"./infobox.min.js";import{distance3 as d,trimPrefix as l,makeTd as m,addRow as f,whatGame as i}from"./utils.min.js";const u=new o(window.icon,idleTimeout),a=new n(document.body,window.infotemplate.content.children[0]),p=new t(window.statsbody,{Total:0,Old:0,New:0,Ignored:0,Taxi:0,Base:0,Horizons:0,Odyssey:0,Legacy:0,Unknown:0,TS:"","Max jump range":""});let T=0;class y{data;gameType;isTaxi;isOld;isNew;constructor(e){this.data=e,this.gameType=i(e),e=e.message,this.isTaxi=!!e.taxi,e=new Date-new Date(e.timestamp),this.isOld=36e5<e,this.isNew=e<-18e4}}function g(e){var o=document.createElement("tr");return o.classList.add("data"),o.classList.add(e.gameType),e.isTaxi&&o.classList.add("taxi"),e.isOld?o.classList.add("old"):e.isNew&&o.classList.add("new"),a.set(o,e.data),o}let v=Date.now();const s=new e(socketUrl);s.onopen=u.idle,s.onclose=u.off,s.onmessage=e=>{let o={};try{o=JSON.parse(e.data)}catch(e){return console.log("JSON parse error:",e),void u.error()}if(e=o.message){u.ok(),v=Date.now(),p.inc("Total");var t,n=new y(o);if(p.inc(n.gameType),p.set("TS",e.timestamp),n.isTaxi&&p.inc("Taxi"),n.isOld?p.inc("Old"):n.isNew&&p.inc("New"),e.event)if(p.inc(e.event),"Scan"===e.event)(t=g(n)).append(m(e.BodyName),m(e.ScanType)),f(window.scanbods,t),!1===e.WasDiscovered&&"NavBeaconDetail"!==e.ScanType&&(e.StarType?((t=g(n)).append(m(e.BodyName),m(e.StarType+" "+e.Subclass)),f(window.newstars,t)):e.PlanetClass&&((t=g(n)).append(m(e.BodyName),m(e.PlanetClass),m(e.AtmosphereType&&"None"!==e.AtmosphereType?e.AtmosphereType:""),m(e.Landable?"Yes":"")),f(window.newplanets,t)));else if("FSDJump"===e.event)(t=g(n)).append(m(e.StarSystem)),f(window.jumps,t),(0<e.Population||e.SystemAllegiance)&&(t=g(n),w=e.SystemFaction||{},t.append(m(e.StarSystem),m(1e9<=e.Population?(e.Population/1e9).toFixed(2)+"G":1e6<=e.Population?(e.Population/1e6).toFixed(2)+"M":1e3<=e.Population?(e.Population/1e3).toFixed(2)+"k":0<e.Population?(+e.Population).toFixed(2):""),m(e.SystemAllegiance),m(w.Name||""),m(w.FactionState||"")),f(window.visits,t));else if("NavRoute"===e.event){var i,a,s=g(n),r=e.Route||[];if(1<r.length){s.append(m(r[0].StarSystem),m(r[r.length-1].StarSystem),m(r.length-1+"j"));let e=0,o=0,t;for(const c of r)t?(i=c.StarPos,a=d(t,i),T<a&&(T=a,p.set("Max jump range",a.toFixed(2)+"ly")),o<a&&(o=a),e+=a,t=i):(t=c.StarPos,s.append(m(d(t,r[r.length-1].StarPos).toFixed(2)+"ly")));s.append(m(2<r.length?e.toFixed(2)+"ly":""));var w=m(o.toFixed(2)+"ly");200<=o&&w.classList.add("longjump"),s.append(w),f(window.routes,s)}else console.log("Short NavRoute:",o)}else"Docked"===e.event||"Location"===e.event?((t=g(n)).append(m(e.StationName||""),m(e.StationType||""),m(e.StarSystem)),f(window.docks,t)):"ApproachSettlement"===e.event?((w=g(n)).append(m(e.Name),m(e.StarSystem)),f(window.asett,w)):"CodexEntry"===e.event?((t=g(n)).append(m(e.System),m(l(e.BodyName||"",e.System)),m(e.SubCategory),m(e.Name)),f(window.codex,t)):p.inc("Ignored");else(w=g(n)).append(m(e.commodities?"Market":e.ships?"Shipyard":e.modules?"Outfitting":""),m(e.stationName),m(e.systemName)),f(window.updates,w)}else console.log("No message: ",o),u.error()},window.board.addEventListener("click",e=>{let o;"TR"===e.target.tagName?o=e.target:"TD"===e.target.tagName&&(o=e.target.parentNode),o&&a.has(o)&&a.show(o)}),function e(){s.readyState===WebSocket.OPEN&&Date.now()-v>resetTimeout&&(console.log("Receive timeout. Resetting connection."),s.refresh());var o=~~(6e4+42e3*Math.random());setTimeout(e,o)}();
