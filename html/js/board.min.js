import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";import{PageIconActivity as t}from"./activity_icon.min.js";import{StatsBox as o,SortedStatsBox as i}from"./statsbox.min.js";import{InfoBox as a}from"./infobox.min.js";import{distance3 as u,trimPrefix as f,makeTd as k,addRow as p,whatGame as n}from"./utils.min.js";const v=new t(window.icon,idleTimeout),s=new a(document.body,window.infotemplate.content.children[0]),h=new o(window.softbody),g=new i(window.eventsbody),x=new o(window.statsbody,{Total:0,Odyssey:0,Horizons:0,Base:0,Legacy:0,Unknown:0,Taxi:0,Multicrew:0,Old:0,New:0,Ignored:0,"Last timestamp":"","Max jump range":""});let y=0;class b{data;gameType;timestamp;event;isTaxi;isMulticrew;isOld;isNew;constructor(e){this.data=e,this.gameType=n(e),e=e.message,this.timestamp=e.timestamp,this.event=e.event,this.isTaxi=!!e.Taxi,this.isMulticrew=!!e.Multicrew,e=new Date-new Date(e.timestamp),this.isOld=36e5<e,this.isNew=e<-18e4}}function S(e){var t=document.createElement("tr");return t.classList.add("data"),t.classList.add(e.gameType),e.isTaxi&&t.classList.add("taxi"),e.isMulticrew&&t.classList.add("multicrew"),e.isOld?t.classList.add("old"):e.isNew&&t.classList.add("new"),s.set(t,e.data),t}let T=Date.now();const r=new e(socketUrl);r.onopen=v.idle,r.onclose=v.off,r.onmessage=e=>{let t;try{if(!((t=JSON.parse(e.data)).$schemaRef&&t.header&&t.message))return console.log("Invalid message:",t),void v.error()}catch(e){return console.log("JSON object error:",e),void v.error()}t.$schemaRef;var o,e=t.header,i=t.message,a=(v.ok(),T=Date.now(),x.inc("Total"),new b(t)),n=(x.inc(a.gameType),x.set("Last timestamp",a.timestamp),window.softbody),s=n.childElementCount;if(h.inc(e.softwareName+" "+e.softwareVersion),n.childElementCount!=s&&n.replaceChildren(...[...n.children].sort((e,t)=>e.children[0].textContent<t.children[0].textContent?1:-1)),a.isTaxi&&x.inc("Taxi"),a.isMulticrew&&x.inc("Multicrew"),a.isOld?x.inc("Old"):a.isNew&&x.inc("New"),a.event)switch(g.inc(a.event),a.event){case"Scan":(o=S(a)).append(k(i.BodyName),k(i.ScanType)),p(window.scanbods,o),!1===i.WasDiscovered&&"NavBeaconDetail"!==i.ScanType&&(i.StarType?((o=S(a)).append(k(i.BodyName),k(i.StarType+" "+i.Subclass)),p(window.newstars,o)):i.PlanetClass&&((o=S(a)).append(k(i.BodyName),k(i.PlanetClass),k(i.AtmosphereType&&"None"!==i.AtmosphereType?i.AtmosphereType:""),k(i.Landable?"Yes":"")),p(window.newplanets,o)));break;case"FSDJump":(o=S(a)).append(k(i.StarSystem)),p(window.jumps,o),(0<i.Population||i.SystemAllegiance)&&(o=S(a),m=i.SystemFaction||{},o.append(k(i.StarSystem),k(1e9<=i.Population?(i.Population/1e9).toFixed(2)+"G":1e6<=i.Population?(i.Population/1e6).toFixed(2)+"M":1e3<=i.Population?(i.Population/1e3).toFixed(2)+"k":0<i.Population?(+i.Population).toFixed(2):""),k(i.SystemAllegiance),k(m.Name||""),k(m.FactionState||"")),p(window.visits,o));break;case"NavRoute":var r=i.Route||[];if(1<r.length){var w,c,d=S(a);d.append(k(r[0].StarSystem),k(r[r.length-1].StarSystem),k(r.length-1+"j"));let e=0,t=0,o;for(const l of r)o?(w=l.StarPos,c=u(o,w),y<c&&(y=c,x.set("Max jump range",c.toFixed(2)+"ly")),t<c&&(t=c),e+=c,o=w):(o=l.StarPos,d.append(k(u(o,r[r.length-1].StarPos).toFixed(2)+"ly")));d.append(k(2<r.length?e.toFixed(2)+"ly":""));var m=k(t.toFixed(2)+"ly");200<=t&&m.classList.add("longjump"),d.append(m),p(window.routes,d)}else console.log("Short NavRoute:",t);break;case"Docked":case"Location":(o=S(a)).append(k(i.StationName||""),k(i.StationType||""),k(i.StarSystem)),p(window.docks,o);break;case"ApproachSettlement":(m=S(a)).append(k(i.Name),k(i.StarSystem)),p(window.asett,m);break;case"CodexEntry":(o=S(a)).append(k(i.System),k(f(i.BodyName||"",i.System)),k(i.SubCategory),k(i.Name)),p(window.codex,o);break;default:x.inc("Ignored")}else(e=S(a)).append(k(i.commodities?"Market":i.ships?"Shipyard":i.modules?"Outfitting":""),k(i.stationName),k(i.systemName)),p(window.updates,e)},window.board.addEventListener("click",e=>{let t;"TR"===e.target.tagName?t=e.target:"TD"===e.target.tagName&&(t=e.target.parentNode),t&&s.has(t)&&s.show(t)}),function e(){r.readyState===WebSocket.OPEN&&Date.now()-T>resetTimeout&&(console.log("Receive timeout. Resetting connection."),r.refresh());var t=~~(6e4+42e3*Math.random());setTimeout(e,t)}();
