import{ReconnectingWebSocket as t}from"./reconnecting-websocket.min.js";import{PageIconActivity as n}from"./activity_icon.min.js";import{StatsBox as o,SortedStatsBox as e}from"./statsbox.min.js";import{InfoBox as i}from"./infobox.min.js";import{distance3 as r,trimPrefix as s,makeTd as l,addRow as m,whatGame as c,GalacticRegions as w}from"./utils.min.js";const a=new n(window.icon,idleTimeout);const f=new i(document.body,window.infotemplate.content.children[0]);const d=new o(window.softbody);const u=new e(window.eventsbody);const _=new o(window.statsbody,{Total:0,Odyssey:0,Horizons:0,Base:0,Legacy:0,Unknown:0,Taxi:0,Multicrew:0,Old:0,New:0,Ignored:0,"Last timestamp":"","Max jump range":""});let h=0;class ${t;o;i;l;m;u;_;h;$;p;g;constructor(t){this.t=t;this.o=c(t);const n=t.message;this.i=t.$schemaRef;this.l=t.header;this.m=n;this.u=n.timestamp;this._=n.event;this.h=!!n.Taxi;this.$=!!n.Multicrew;const o=new Date-new Date(n.timestamp);this.p=o>3600*1e3;this.g=o<-180*1e3}}function p(t){const n=document.createElement("tr");n.classList.add("data");n.classList.add(t.o);if(t.h){n.classList.add("taxi")}if(t.$){n.classList.add("multicrew")}if(t.p){n.classList.add("old")}else if(t.g){n.classList.add("new")}f.set(n,t.t);return n}let g=Date.now();const y=new t(socketUrl);y.onopen=a.idle;y.onclose=a.off;y.onmessage=t=>{let n;try{n=JSON.parse(t.data);if(!(n.$schemaRef&&n.header&&n.message)){console.log("Invalid message:",n);a.error();return}}catch(t){console.log("JSON object error:",t,n);a.error();return}a.ok();g=Date.now();const o=new $(n);x(o);N(o);T(o)};function x(t){_.set("Last timestamp",t.u);_.inc("Total");_.inc(t.o);if(t.h){_.inc("Taxi")}if(t.$){_.inc("Multicrew")}if(t.p){_.inc("Old")}else if(t.g){_.inc("New")}}function N(t){const n=window.softbody;const o=n.childElementCount;const e=t.l;d.inc(`${e.softwareName} ${e.softwareVersion}`);if(n.childElementCount!=o){n.replaceChildren(...[...n.children].sort((t,n)=>t.children[0].textContent<n.children[0].textContent?1:-1))}}function T(t){if(t._){u.inc(t._);(j[t._]||D)(t)}else{S(t)}}const j={Scan:k,FSDJump:M,NavRoute:v,Docked:O,Location:O,ApproachSettlement:R,CodexEntry:b};function D(t){_.inc("Ignored")}function S(t){const n=t.m;const o=p(t);o.append(l(n.commodities?"Market":n.ships?"Shipyard":n.modules?"Outfitting":""),l(n.stationName),l(n.systemName));m(window.updates,o)}function k(t){const n=t.m;const o=p(t);o.append(l(n.BodyName),l(n.ScanType));m(window.scanbods,o);if(n.WasDiscovered===false&&n.WasMapped===false&&n.ScanType!=="NavBeaconDetail"){if(n.StarType){const o=p(t);o.append(l(n.BodyName),l(`${n.StarType} ${n.Subclass}`));m(window.newstars,o)}else if(n.PlanetClass){const o=p(t);o.append(l(n.BodyName),l(n.PlanetClass),l(n.AtmosphereType&&n.AtmosphereType!=="None"?n.AtmosphereType:""),l(n.Landable?"Yes":""));m(window.newplanets,o)}}}function M(t){const n=t.m;const o=p(t);o.append(l(n.StarSystem));m(window.jumps,o);if(n.Population>0||n.SystemAllegiance){const o=p(t);const e=n.SystemFaction||{};o.append(l(n.StarSystem),l(n.Population>=1e9?(n.Population/1e9).toFixed(2)+"G":n.Population>=1e6?(n.Population/1e6).toFixed(2)+"M":n.Population>=1e3?(n.Population/1e3).toFixed(2)+"k":n.Population>0?(n.Population/1).toFixed(2):""),l(n.SystemAllegiance),l(e.Name||""),l(e.FactionState||""));m(window.visits,o)}}function v(e){const t=e.m;const i=t.Route||[];if(i.length>1){const s=p(e);s.append(l(i[0].StarSystem),l(i[i.length-1].StarSystem),l(`${i.length-1}j`));let t=0;let n=0;let o;for(const w of i){if(!o){o=w.StarPos;s.append(l(`${r(o,i[i.length-1].StarPos).toFixed(2)}ly`));continue}const a=w.StarPos;const f=r(o,a);if(h<f){h=f;_.set("Max jump range",`${f.toFixed(2)}ly`)}if(n<f){n=f}t+=f;o=a}s.append(l(i.length>2?`${t.toFixed(2)}ly`:""));const c=l(`${n.toFixed(2)}ly`);if(n>=200){c.classList.add("longjump")}s.append(c);m(window.routes,s)}else{console.log("Short NavRoute:",e.t)}}function O(t){const n=t.m;const o=p(t);o.append(l(n.StationName||""),l(n.StationType||""),l(n.StarSystem));m(window.docks,o)}function R(t){const n=t.m;const o=p(t);o.append(l(n.Name),l(n.StarSystem));m(window.asett,o)}function b(t){const n=t.m;const o=p(t);o.append(l(n.System),l(s(n.BodyName||"",n.System)),l(n.SubCategory.replace(/^\$Codex_SubCategory_(.*);$/,"$1").replaceAll("_"," ")),l(n.Name.replace(/^\$Codex_Ent_(.*)_Name;$/,"$1").replaceAll("_"," ")),l(w[n.Region.replace(/^\$Codex_RegionName_(.*);$/,"$1")]));m(window.codex,o)}window.board.addEventListener("click",t=>{let n;if(t.target.tagName==="TR"){n=t.target}else if(t.target.tagName==="TD"){n=t.target.parentNode}if(n&&f.has(n)){f.show(n)}});(function t(){if(y.readyState===WebSocket.OPEN&&Date.now()-g>resetTimeout){console.log("Receive timeout. Resetting connection.");y.refresh()}const n=~~(6e4+Math.random()*42e3);setTimeout(t,n)})();
