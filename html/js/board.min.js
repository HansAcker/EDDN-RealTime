import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";const h=(e,t)=>Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2]),m=e=>{var t=document.createElement("td");return t.textContent=t.title=e,t};function y(e,t){for(;e.children.length>=listLength;)e.removeChild(e.lastChild);e.insertBefore(t,e.firstChild)}const u={Total:0,Old:0,New:0,Ignored:0,Taxi:0,Base:0,Horizons:0,Odyssey:0,Legacy:0,Unknown:0,TS:"","Max jump range":""};let C=statstable.querySelector("tbody"),S=0,g=Date.now();const n={ok:"img/led/led-circle-green.svg",off:"img/led/led-circle-red.svg",idle:"img/led/led-circle-grey.svg",error:"img/led/led-circle-yellow.svg"};let a=null,o="off";const d=()=>{o="idle",icon.href=n[o],a=null};function v(e,t=0){a&&(clearTimeout(a),a=null),o!=e&&(console.log(o+" => "+e),icon.href=n[e],o=e),t&&(a=setTimeout(d,t))}const l=new e(socketUrl);l.onopen=v.bind(null,"idle",0),l.onclose=v.bind(null,"off",0),l.onmessage=e=>{v("ok",1600);let t={};try{t=JSON.parse(e.data)}catch(e){return console.log("JSON parse error:",e),void v("error")}if(u.Total++,g=Date.now(),e=t.message){var a=function(e){try{var t,n=e.header.gameversion;return n&&(n.startsWith("CAPI-Legacy-")||parseInt(n)<4)?"Legacy":(t=e.message).odyssey?"Odyssey":t.horizons?"Horizons":!1===t.horizons?"Base":"Unknown"}catch(e){return console.log("gameversion error:",e),"Unknown"}}(t),o=(u[a]++,document.createElement("tr"));o.classList.add(a),e.Taxi&&(u.Taxi++,o.classList.add("taxi")),u.TS=e.timestamp;try{var n=new Date-new Date(e.timestamp);36e5<n?(o.classList.add("old"),u.Old++):n<-18e4&&(o.classList.add("new"),u.New++)}catch(e){console.log("Invalid date:",e)}if(e.event)if(e.event in u||(u[e.event]=0),u[e.event]++,"Scan"===e.event&&"NavBeaconDetail"!==e.ScanType&&!1===e.WasDiscovered)o.appendChild(m(e.BodyName)),o.appendChild(m(e.ScanType)),y(newbods,o),e.StarType?((n=document.createElement("tr")).classList.add(a),n.appendChild(m(e.BodyName)),n.appendChild(m(e.StarType+" "+e.Subclass)),y(newstars,n)):e.PlanetClass&&((n=document.createElement("tr")).classList.add(a),n.appendChild(m(e.BodyName)),n.appendChild(m(e.PlanetClass)),n.appendChild(m(""+(e.AtmosphereType&&"None"!==e.AtmosphereType?e.AtmosphereType:""))),n.appendChild(m(e.Landable?"Yes":"")),y(newplanets,n));else if("Scan"!==e.event||"NavBeaconDetail"!==e.ScanType&&!1===e.WasDiscovered)if("FSDJump"===e.event)o.appendChild(m(e.StarSystem)),y(jumps,o),(0<e.Population||e.SystemAllegiance)&&((n=document.createElement("tr")).classList.add(a),n.appendChild(m(e.StarSystem)),n.appendChild(m(""+(1e9<=e.Population?(e.Population/1e9).toFixed(2)+"G":1e6<=e.Population?(e.Population/1e6).toFixed(2)+"M":1e3<=e.Population?(e.Population/1e3).toFixed(2)+"k":0<e.Population?(+e.Population).toFixed(2):""))),n.appendChild(m(e.SystemAllegiance)),a=e.SystemFaction||{},n.appendChild(m(a.Name)),n.appendChild(m(a.FactionState)),y(visits,n));else if("FSSDiscoveryScan"===e.event)o.appendChild(m(e.SystemName)),o.appendChild(m(e.BodyCount)),o.appendChild(m(e.NonBodyCount)),y(honks,o);else if("Docked"===e.event||"Location"===e.event)o.appendChild(m(e.StationName)),o.appendChild(m(e.StationType)),o.appendChild(m(e.StarSystem)),y(docks,o);else if("NavRoute"===e.event)if(1<(a=e.Route||[]).length){o.appendChild(m(a[0].StarSystem)),o.appendChild(m(a[a.length-1].StarSystem)),o.appendChild(m(a.length-1+"j"));try{let e=0,t=0,n=a.shift().StarPos;o.appendChild(m(h(n,a[a.length-1].StarPos).toFixed(2)+"ly"));for(const r of a){var d=r.StarPos,l=h(n,d);S<l&&(S=l,u["Max jump range"]=l.toFixed(2)+"ly"),t<l&&(t=l),e+=l,n=d}o.appendChild(m(1<a.length?e.toFixed(2)+"ly":""));var i=m(t.toFixed(2)+"ly");200<=t&&i.classList.add("longjump"),o.appendChild(i)}catch(e){console.log("Error in route:",e)}y(routes,o)}else console.log("Short NavRoute:",t);else"ApproachSettlement"===e.event?(o.appendChild(m(e.Name)),o.appendChild(m(e.StarSystem)),y(asett,o)):"CodexEntry"===e.event?(o.appendChild(m(e.System)),o.appendChild(m((n=e.BodyName||"",a=e.System,(n.startsWith(a)?n.slice(a.length):n).trim()))),o.appendChild(m(e.SubCategory)),o.appendChild(m(e.Name)),y(codex,o)):u.Ignored++;else o.appendChild(m(e.BodyName)),o.appendChild(m(e.ScanType)),y(oldbods,o);else o.appendChild(m(e.commodities?"Market":e.ships?"Shipyard":e.modules?"Outfitting":"")),o.appendChild(m(e.stationName)),o.appendChild(m(e.systemName)),y(updates,o);if(!document.hidden){var s=document.createElement("tbody");for(const c in u){var p=document.createElement("tr");p.appendChild(m(c)),p.appendChild(m(u[c])),s.appendChild(p)}statstable.replaceChild(s,C),C=s}}else console.log("No message: ",t)},function e(){l.readyState===WebSocket.OPEN&&3e5<Date.now()-g&&(console.log("Receive timeout. Resetting connection."),l.refresh());var t=~~(6e4+23e3*Math.random());setTimeout(e,t)}();
