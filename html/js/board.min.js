import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";const m=(e,t)=>Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2]),p=e=>{var t=document.createElement("td");return t.textContent=t.title=e,t};function u(e,t){for(;e.childElementCount>=listLength;)e.lastElementChild.remove();e.prepend(t)}const o={ok:"img/led/led-circle-green.svg",off:"img/led/led-circle-red.svg",idle:"img/led/led-circle-grey.svg",error:"img/led/led-circle-yellow.svg"};let n=null,a="off";const s=y.bind(null,"idle",0);function y(e,t=0){n&&(clearTimeout(n),n=null),a!=e&&(console.log(a+" => "+e),icon.href=o[e],a=e),t&&(n=setTimeout(s,t))}const g={Total:0,Old:0,New:0,Ignored:0,Taxi:0,Base:0,Horizons:0,Odyssey:0,Legacy:0,Unknown:0,TS:"","Max jump range":""};let S=0,v=statstable.querySelector("tbody"),h=Date.now();const l=new e(socketUrl);l.onopen=y.bind(null,"idle",0),l.onclose=y.bind(null,"off",0),l.onmessage=e=>{let t={};try{t=JSON.parse(e.data)}catch(e){return console.log("JSON parse error:",e),void y("error")}if(e=t.message){y("ok",idleTimeout),h=Date.now(),g.Total++;var n=function(e){try{var t,o=e.header.gameversion;return o&&(o.startsWith("CAPI-Legacy-")||parseInt(o)<4)?"Legacy":(t=e.message).odyssey?"Odyssey":t.horizons?"Horizons":!1===t.horizons?"Base":"Unknown"}catch(e){return console.log("gameversion error:",e),"Unknown"}}(t),a=(g[n]++,document.createElement("tr"));a.classList.add(n),e.Taxi&&(g.Taxi++,a.classList.add("taxi")),g.TS=e.timestamp;try{36e5<(o=new Date-new Date(e.timestamp))?(a.classList.add("old"),g.Old++):o<-18e4&&(a.classList.add("new"),g.New++)}catch(e){console.log("Invalid date:",e)}if(e.event)if(e.event in g||(g[e.event]=0),g[e.event]++,"Scan"===e.event){if(a.append(p(e.BodyName),p(e.ScanType)),!1!==e.WasDiscovered||"NavBeaconDetail"===e.ScanType)u(oldbods,a);else if(u(newbods,a),e.StarType){const a=document.createElement("tr");a.classList.add(n),a.append(p(e.BodyName),p(e.StarType+" "+e.Subclass)),u(newstars,a)}else if(e.PlanetClass){const a=document.createElement("tr");a.classList.add(n),a.append(p(e.BodyName),p(e.PlanetClass),p(e.AtmosphereType&&"None"!==e.AtmosphereType?e.AtmosphereType:""),p(e.Landable?"Yes":"")),u(newplanets,a)}}else if("FSDJump"===e.event){if(a.append(p(e.StarSystem)),u(jumps,a),0<e.Population||e.SystemAllegiance){const a=document.createElement("tr");a.classList.add(n);var o=e.SystemFaction||{};a.append(p(e.StarSystem),p(1e9<=e.Population?(e.Population/1e9).toFixed(2)+"G":1e6<=e.Population?(e.Population/1e6).toFixed(2)+"M":1e3<=e.Population?(e.Population/1e3).toFixed(2)+"k":0<e.Population?(+e.Population).toFixed(2):""),p(e.SystemAllegiance),p(o.Name),p(o.FactionState)),u(visits,a)}}else if("FSSDiscoveryScan"===e.event)a.append(p(e.SystemName),p(e.BodyCount),p(e.NonBodyCount)),u(honks,a);else if("NavRoute"===e.event)if(1<(n=e.Route||[]).length){a.append(p(n[0].StarSystem),p(n[n.length-1].StarSystem),p(n.length-1+"j"));try{let e=0,t=0,o=n.shift().StarPos;a.append(p(m(o,n[n.length-1].StarPos).toFixed(2)+"ly"));for(const d of n){var s=d.StarPos,l=m(o,s);S<l&&(S=l,g["Max jump range"]=l.toFixed(2)+"ly"),t<l&&(t=l),e+=l,o=s}a.append(p(1<n.length?e.toFixed(2)+"ly":""));var r=p(t.toFixed(2)+"ly");200<=t&&r.classList.add("longjump"),a.append(r)}catch(e){console.log("Error in route:",e)}u(routes,a)}else console.log("Short NavRoute:",t);else"Docked"===e.event||"Location"===e.event?(a.append(p(e.StationName),p(e.StationType),p(e.StarSystem)),u(docks,a)):"ApproachSettlement"===e.event?(a.append(p(e.Name),p(e.StarSystem)),u(asett,a)):"CodexEntry"===e.event?(a.append(p(e.System),p((o=e.BodyName||"",n=e.System,(o.startsWith(n)?o.slice(n.length):o).trim())),p(e.SubCategory),p(e.Name)),u(codex,a)):g.Ignored++;else a.append(p(e.commodities?"Market":e.ships?"Shipyard":e.modules?"Outfitting":""),p(e.stationName),p(e.systemName)),u(updates,a);if(!document.hidden){var i=document.createElement("tbody");for(const c in g){const a=document.createElement("tr");a.append(p(c),p(g[c])),i.append(a)}v.replaceWith(i),v=i}}else console.log("No message: ",t),y("error")},function e(){l.readyState===WebSocket.OPEN&&Date.now()-h>resetTimeout&&(console.log("Receive timeout. Resetting connection."),l.refresh());var t=~~(6e4+42e3*Math.random());setTimeout(e,t)}();
