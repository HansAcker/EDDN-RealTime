import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";import{ActivityIcon as t}from"./activity_icon.min.js";import{StatsBox as o}from"./statsbox.min.js";import{InfoBox as a}from"./infobox.min.js";import{distance3 as m,trimPrefix as d,makeTd as f,addRow as u,whatGame as p}from"./utils.min.js";const w=new o(statstable.querySelector("tbody"),{Total:0,Old:0,New:0,Ignored:0,Taxi:0,Base:0,Horizons:0,Odyssey:0,Legacy:0,Unknown:0,TS:"","Max jump range":""});let y=0,v=Date.now();const n=new e(socketUrl),x=new t(icon,idleTimeout),S=new a(document.body,infotemplate.content.children[0].cloneNode(!0));n.onopen=x.idle,n.onclose=x.off,n.onmessage=e=>{let t={};try{t=JSON.parse(e.data)}catch(e){return console.log("JSON parse error:",e),void x.error()}e=t.message;if(e){x.ok(),v=Date.now(),w.inc("Total");var o=p(t),a=(w.inc(o),document.createElement("tr"));a.classList.add("data"),a.classList.add(o),S.set(a,t),e.Taxi&&(w.inc("Taxi"),a.classList.add("taxi")),w.set("TS",e.timestamp);try{var n=new Date-new Date(e.timestamp);36e5<n?(a.classList.add("old"),w.inc("Old")):n<-18e4&&(a.classList.add("new"),w.inc("New"))}catch(e){console.log("Invalid date:",e)}if(e.event)if(w.inc(e.event),"Scan"===e.event){if(a.append(f(e.BodyName),f(e.ScanType)),u(scanbods,a),!1===e.WasDiscovered&&"NavBeaconDetail"!==e.ScanType)if(e.StarType){const a=document.createElement("tr");a.classList.add("data"),a.classList.add(o),S.set(a,t),a.append(f(e.BodyName),f(e.StarType+" "+e.Subclass)),u(newstars,a)}else if(e.PlanetClass){const a=document.createElement("tr");a.classList.add("data"),a.classList.add(o),S.set(a,t),a.append(f(e.BodyName),f(e.PlanetClass),f(e.AtmosphereType&&"None"!==e.AtmosphereType?e.AtmosphereType:""),f(e.Landable?"Yes":"")),u(newplanets,a)}}else if("FSDJump"===e.event){if(a.append(f(e.StarSystem)),u(jumps,a),0<e.Population||e.SystemAllegiance){const a=document.createElement("tr");a.classList.add("data"),a.classList.add(o),S.set(a,t);n=e.SystemFaction||{};a.append(f(e.StarSystem),f(1e9<=e.Population?(e.Population/1e9).toFixed(2)+"G":1e6<=e.Population?(e.Population/1e6).toFixed(2)+"M":1e3<=e.Population?(e.Population/1e3).toFixed(2)+"k":0<e.Population?(+e.Population).toFixed(2):""),f(e.SystemAllegiance),f(n.Name||""),f(n.FactionState||"")),u(visits,a)}}else if("NavRoute"===e.event){var s,i,c=e.Route||[];if(1<c.length){a.append(f(c[0].StarSystem),f(c[c.length-1].StarSystem),f(c.length-1+"j"));try{let e=0,t=0,o;for(const l of c)o?(s=l.StarPos,i=m(o,s),y<i&&(y=i,w.set("Max jump range",i.toFixed(2)+"ly")),t<i&&(t=i),e+=i,o=s):(o=l.StarPos,a.append(f(m(o,c[c.length-1].StarPos).toFixed(2)+"ly")));a.append(f(2<c.length?e.toFixed(2)+"ly":""));var r=f(t.toFixed(2)+"ly");200<=t&&r.classList.add("longjump"),a.append(r)}catch(e){console.log("Error in route:",e)}u(routes,a)}else console.log("Short NavRoute:",t)}else"Docked"===e.event||"Location"===e.event?(a.append(f(e.StationName||""),f(e.StationType||""),f(e.StarSystem)),u(docks,a)):"ApproachSettlement"===e.event?(a.append(f(e.Name),f(e.StarSystem)),u(asett,a)):"CodexEntry"===e.event?(a.append(f(e.System),f(d(e.BodyName||"",e.System)),f(e.SubCategory),f(e.Name)),u(codex,a)):w.inc("Ignored");else a.append(f(e.commodities?"Market":e.ships?"Shipyard":e.modules?"Outfitting":""),f(e.stationName),f(e.systemName)),u(updates,a)}else console.log("No message: ",t),x.error()},board.addEventListener("click",e=>{let t;"TR"===e.target.tagName?t=e.target:"TD"===e.target.tagName&&(t=e.target.parentNode),t&&S.has(t)&&S.show(t)}),function e(){n.readyState===WebSocket.OPEN&&Date.now()-v>resetTimeout&&(console.log("Receive timeout. Resetting connection."),n.refresh());var t=~~(6e4+42e3*Math.random());setTimeout(e,t)}();
