import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";import{ActivityIcon as o}from"./activity_icon.min.js";import{StatsBox as t}from"./statsbox.min.js";import{InfoBox as n}from"./infobox.min.js";import{distance3 as d,trimPrefix as l,makeTd as m,addRow as f,whatGame as u}from"./utils.min.js";const y=new t(window.statsbody,{Total:0,Old:0,New:0,Ignored:0,Taxi:0,Base:0,Horizons:0,Odyssey:0,Legacy:0,Unknown:0,TS:"","Max jump range":""});let p=0,v=Date.now();const i=new e(socketUrl),S=new o(window.icon,idleTimeout),T=new n(document.body,window.infotemplate.content.children[0]);i.onopen=S.idle,i.onclose=S.off,i.onmessage=e=>{let o={};try{o=JSON.parse(e.data)}catch(e){return console.log("JSON parse error:",e),void S.error()}e=o.message;if(e){S.ok(),v=Date.now(),y.inc("Total");var t=u(o),n=(y.inc(t),document.createElement("tr"));n.classList.add("data"),n.classList.add(t),T.set(n,o),e.Taxi&&(y.inc("Taxi"),n.classList.add("taxi")),y.set("TS",e.timestamp);try{var i=new Date-new Date(e.timestamp);36e5<i?(n.classList.add("old"),y.inc("Old")):i<-18e4&&(n.classList.add("new"),y.inc("New"))}catch(e){console.log("Invalid date:",e)}if(e.event)if(y.inc(e.event),"Scan"===e.event){if(n.append(m(e.BodyName),m(e.ScanType)),f(window.scanbods,n),!1===e.WasDiscovered&&"NavBeaconDetail"!==e.ScanType)if(e.StarType){const n=document.createElement("tr");n.classList.add("data"),n.classList.add(t),T.set(n,o),n.append(m(e.BodyName),m(e.StarType+" "+e.Subclass)),f(window.newstars,n)}else if(e.PlanetClass){const n=document.createElement("tr");n.classList.add("data"),n.classList.add(t),T.set(n,o),n.append(m(e.BodyName),m(e.PlanetClass),m(e.AtmosphereType&&"None"!==e.AtmosphereType?e.AtmosphereType:""),m(e.Landable?"Yes":"")),f(window.newplanets,n)}}else if("FSDJump"===e.event){if(n.append(m(e.StarSystem)),f(window.jumps,n),0<e.Population||e.SystemAllegiance){const n=document.createElement("tr");n.classList.add("data"),n.classList.add(t),T.set(n,o);i=e.SystemFaction||{};n.append(m(e.StarSystem),m(1e9<=e.Population?(e.Population/1e9).toFixed(2)+"G":1e6<=e.Population?(e.Population/1e6).toFixed(2)+"M":1e3<=e.Population?(e.Population/1e3).toFixed(2)+"k":0<e.Population?(+e.Population).toFixed(2):""),m(e.SystemAllegiance),m(i.Name||""),m(i.FactionState||"")),f(window.visits,n)}}else if("NavRoute"===e.event){var a,s,c=e.Route||[];if(1<c.length){n.append(m(c[0].StarSystem),m(c[c.length-1].StarSystem),m(c.length-1+"j"));try{let e=0,o=0,t;for(const w of c)t?(a=w.StarPos,s=d(t,a),p<s&&(p=s,y.set("Max jump range",s.toFixed(2)+"ly")),o<s&&(o=s),e+=s,t=a):(t=w.StarPos,n.append(m(d(t,c[c.length-1].StarPos).toFixed(2)+"ly")));n.append(m(2<c.length?e.toFixed(2)+"ly":""));var r=m(o.toFixed(2)+"ly");200<=o&&r.classList.add("longjump"),n.append(r)}catch(e){console.log("Error in route:",e)}f(window.routes,n)}else console.log("Short NavRoute:",o)}else"Docked"===e.event||"Location"===e.event?(n.append(m(e.StationName||""),m(e.StationType||""),m(e.StarSystem)),f(window.docks,n)):"ApproachSettlement"===e.event?(n.append(m(e.Name),m(e.StarSystem)),f(window.asett,n)):"CodexEntry"===e.event?(n.append(m(e.System),m(l(e.BodyName||"",e.System)),m(e.SubCategory),m(e.Name)),f(window.codex,n)):y.inc("Ignored");else n.append(m(e.commodities?"Market":e.ships?"Shipyard":e.modules?"Outfitting":""),m(e.stationName),m(e.systemName)),f(window.updates,n)}else console.log("No message: ",o),S.error()},window.board.addEventListener("click",e=>{let o;"TR"===e.target.tagName?o=e.target:"TD"===e.target.tagName&&(o=e.target.parentNode),o&&T.has(o)&&T.show(o)}),function e(){i.readyState===WebSocket.OPEN&&Date.now()-v>resetTimeout&&(console.log("Receive timeout. Resetting connection."),i.refresh());var o=~~(6e4+42e3*Math.random());setTimeout(e,o)}();
