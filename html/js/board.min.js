import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";import{ActivityIcon as t}from"./activity_icon.min.js";import{StatsBox as o}from"./statsbox.min.js";import{InfoBox as n}from"./infobox.min.js";const l=(e,t)=>Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2]),m=e=>{var t=document.createElement("td");return t.textContent=t.title=e,t};function u(e,t){for(;e.childElementCount>=listLength;)e.lastElementChild.remove();e.prepend(t)}const d=new o(statstable.querySelector("tbody"),{Total:0,Old:0,New:0,Ignored:0,Taxi:0,Base:0,Horizons:0,Odyssey:0,Legacy:0,Unknown:0,TS:"","Max jump range":""});let f=0,y=Date.now();const s=new e(socketUrl),p=new t(icon,idleTimeout),v=new n(document.body,infotemplate.content.children[0].cloneNode(!0));s.onopen=p.idle,s.onclose=p.off,s.onmessage=e=>{let t={};try{t=JSON.parse(e.data)}catch(e){return console.log("JSON parse error:",e),void p.error()}if(e=t.message){p.ok(),y=Date.now(),d.inc("Total");var n=function(e){try{var t,o=e.header.gameversion;return o&&(o.startsWith("CAPI-Legacy-")||parseInt(o)<4)?"Legacy":(t=e.message).odyssey?"Odyssey":t.horizons?"Horizons":!1===t.horizons?"Base":"Unknown"}catch(e){return console.log("gameversion error:",e),"Unknown"}}(t),s=(d.inc(n),document.createElement("tr"));s.classList.add(n),v.set(s,t),e.Taxi&&(d.inc("Taxi"),s.classList.add("taxi")),d.set("TS",e.timestamp);try{36e5<(o=new Date-new Date(e.timestamp))?(s.classList.add("old"),d.inc("Old")):o<-18e4&&(s.classList.add("new"),d.inc("New"))}catch(e){console.log("Invalid date:",e)}if(e.event)if(d.inc(e.event),"Scan"===e.event){if(s.append(m(e.BodyName),m(e.ScanType)),u(scanbods,s),!1===e.WasDiscovered&&"NavBeaconDetail"!==e.ScanType)if(e.StarType){const s=document.createElement("tr");s.classList.add(n),v.set(s,t),s.append(m(e.BodyName),m(e.StarType+" "+e.Subclass)),u(newstars,s)}else if(e.PlanetClass){const s=document.createElement("tr");s.classList.add(n),v.set(s,t),s.append(m(e.BodyName),m(e.PlanetClass),m(e.AtmosphereType&&"None"!==e.AtmosphereType?e.AtmosphereType:""),m(e.Landable?"Yes":"")),u(newplanets,s)}}else if("FSDJump"===e.event){if(s.append(m(e.StarSystem)),u(jumps,s),0<e.Population||e.SystemAllegiance){const s=document.createElement("tr");s.classList.add(n),v.set(s,t);var o=e.SystemFaction||{};s.append(m(e.StarSystem),m(1e9<=e.Population?(e.Population/1e9).toFixed(2)+"G":1e6<=e.Population?(e.Population/1e6).toFixed(2)+"M":1e3<=e.Population?(e.Population/1e3).toFixed(2)+"k":0<e.Population?(+e.Population).toFixed(2):""),m(e.SystemAllegiance),m(o.Name||""),m(o.FactionState||"")),u(visits,s)}}else if("NavRoute"===e.event)if(1<(n=e.Route||[]).length){s.append(m(n[0].StarSystem),m(n[n.length-1].StarSystem),m(n.length-1+"j"));try{let e=0,t=0,o=n.shift().StarPos;s.append(m(l(o,n[n.length-1].StarPos).toFixed(2)+"ly"));for(const i of n){var a=i.StarPos,r=l(o,a);f<r&&(f=r,d.set("Max jump range",r.toFixed(2)+"ly")),t<r&&(t=r),e+=r,o=a}s.append(m(1<n.length?e.toFixed(2)+"ly":""));var c=m(t.toFixed(2)+"ly");200<=t&&c.classList.add("longjump"),s.append(c)}catch(e){console.log("Error in route:",e)}u(routes,s)}else console.log("Short NavRoute:",t);else"Docked"===e.event||"Location"===e.event?(s.append(m(e.StationName||""),m(e.StationType||""),m(e.StarSystem)),u(docks,s)):"ApproachSettlement"===e.event?(s.append(m(e.Name),m(e.StarSystem)),u(asett,s)):"CodexEntry"===e.event?(s.append(m(e.System),m((o=e.BodyName||"",n=e.System,(o.startsWith(n)?o.slice(n.length):o).trim())),m(e.SubCategory),m(e.Name)),u(codex,s)):d.inc("Ignored");else s.append(m(e.commodities?"Market":e.ships?"Shipyard":e.modules?"Outfitting":""),m(e.stationName),m(e.systemName)),u(updates,s)}else console.log("No message: ",t),p.error()},board.addEventListener("click",e=>{let t;"TR"===e.target.tagName?t=e.target:"TD"===e.target.tagName&&(t=e.target.parentNode),t&&v.has(t)&&v.show(t)}),function e(){s.readyState===WebSocket.OPEN&&Date.now()-y>resetTimeout&&(console.log("Receive timeout. Resetting connection."),s.refresh());var t=~~(6e4+42e3*Math.random());setTimeout(e,t)}();
