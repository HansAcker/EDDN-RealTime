import{ReconnectingWebSocket as t}from"./reconnecting-websocket.min.js";import{PageIconActivity as e}from"./activity_icon.min.js";import{StatsBox as n,SortedStatsBox as o}from"./statsbox.min.js";import{InfoBox as i}from"./infobox.min.js";import{distance3 as f,trimPrefix as s,makeTd as l,addRow as m,whatGame as c,GalacticRegions as a}from"./utils.min.js";const w=new e(window.icon,idleTimeout);const r=new i(document.body,window.infotemplate.content.children[0]);const d=new n(window.softbody);const u=new o(window.eventsbody);const _=new n(window.statsbody,{Total:0,Odyssey:0,Horizons:0,Base:0,Legacy:0,Unknown:0,Taxi:0,Multicrew:0,Old:0,New:0,Ignored:0,"Last timestamp":"","Max jump range":""});let h=0;class ${t;o;i;l;m;u;_;h;$;p;g;constructor(t){this.t=t;this.o=c(t);const e=t.message;this.i=t.$schemaRef;this.l=t.header;this.m=e;this.u=e.timestamp;this._=e.event;this.h=!!e.Taxi;this.$=!!e.Multicrew;const n=new Date-new Date(e.timestamp);this.p=n>3600*1e3;this.g=n<-180*1e3}}function p(t){const e=document.createElement("tr");e.classList.add("data");e.classList.add(t.o);if(t.h){e.classList.add("taxi")}if(t.$){e.classList.add("multicrew")}if(t.p){e.classList.add("old")}else if(t.g){e.classList.add("new")}r.set(e,t.t);return e}let g=Date.now();const k=new t(socketUrl);k.onopen=w.idle;k.onclose=w.off;k.onmessage=t=>{let e;try{e=JSON.parse(t.data);if(!(e.$schemaRef&&e.header&&e.message)){console.log("Invalid message:",e);w.error();return}}catch(t){console.log("JSON object error:",t,e);w.error();return}w.ok();g=Date.now();const n=new $(e);y(n);b(n);x(n)};function y(t){_.set("Last timestamp",t.u);_.inc("Total");_.inc(t.o);if(t.h){_.inc("Taxi")}if(t.$){_.inc("Multicrew")}if(t.p){_.inc("Old")}else if(t.g){_.inc("New")}}function b(t){const e=window.softbody;const n=e.childElementCount;const o=t.l;d.inc(`${o.softwareName} ${o.softwareVersion}`);if(e.childElementCount!=n){e.replaceChildren(...[...e.children].sort((t,e)=>t.children[0].textContent<e.children[0].textContent?1:-1))}}function x(t){if(t._){u.inc(t._);switch(t._){case"Scan":N(t);break;case"FSDJump":T(t);break;case"NavRoute":j(t);break;case"Docked":case"Location":D(t);break;case"ApproachSettlement":S(t);break;case"CodexEntry":M(t);break;default:_.inc("Ignored")}}else{const e=t.m;const n=p(t);n.append(l(e.commodities?"Market":e.ships?"Shipyard":e.modules?"Outfitting":""),l(e.stationName),l(e.systemName));m(window.updates,n)}}function N(t){const e=t.m;const n=p(t);n.append(l(e.BodyName),l(e.ScanType));m(window.scanbods,n);if(e.WasDiscovered===false&&e.WasMapped===false&&e.ScanType!=="NavBeaconDetail"){if(e.StarType){const n=p(t);n.append(l(e.BodyName),l(`${e.StarType} ${e.Subclass}`));m(window.newstars,n)}else if(e.PlanetClass){const n=p(t);n.append(l(e.BodyName),l(e.PlanetClass),l(e.AtmosphereType&&e.AtmosphereType!=="None"?e.AtmosphereType:""),l(e.Landable?"Yes":""));m(window.newplanets,n)}}}function T(t){const e=t.m;const n=p(t);n.append(l(e.StarSystem));m(window.jumps,n);if(e.Population>0||e.SystemAllegiance){const n=p(t);const o=e.SystemFaction||{};n.append(l(e.StarSystem),l(e.Population>=1e9?(e.Population/1e9).toFixed(2)+"G":e.Population>=1e6?(e.Population/1e6).toFixed(2)+"M":e.Population>=1e3?(e.Population/1e3).toFixed(2)+"k":e.Population>0?(e.Population/1).toFixed(2):""),l(e.SystemAllegiance),l(o.Name||""),l(o.FactionState||""));m(window.visits,n)}}function j(o){const t=o.m;const i=t.Route||[];if(i.length>1){const s=p(o);s.append(l(i[0].StarSystem),l(i[i.length-1].StarSystem),l(`${i.length-1}j`));let t=0;let e=0;let n;for(const a of i){if(!n){n=a.StarPos;s.append(l(`${f(n,i[i.length-1].StarPos).toFixed(2)}ly`));continue}const w=a.StarPos;const r=f(n,w);if(h<r){h=r;_.set("Max jump range",`${r.toFixed(2)}ly`)}if(e<r){e=r}t+=r;n=w}s.append(l(i.length>2?`${t.toFixed(2)}ly`:""));const c=l(`${e.toFixed(2)}ly`);if(e>=200){c.classList.add("longjump")}s.append(c);m(window.routes,s)}else{console.log("Short NavRoute:",o.t)}}function D(t){const e=t.m;const n=p(t);n.append(l(e.StationName||""),l(e.StationType||""),l(e.StarSystem));m(window.docks,n)}function S(t){const e=t.m;const n=p(t);n.append(l(e.Name),l(e.StarSystem));m(window.asett,n)}function M(t){const e=t.m;const n=p(t);n.append(l(e.System),l(s(e.BodyName||"",e.System)),l(e.SubCategory.replace(/^\$Codex_SubCategory_(.*);$/,"$1").replaceAll("_"," ")),l(e.Name.replace(/^\$Codex_Ent_(.*)_Name;$/,"$1").replaceAll("_"," ")),l(a[e.Region.replace(/^\$Codex_RegionName_(.*);$/,"$1")]));m(window.codex,n)}window.board.addEventListener("click",t=>{let e;if(t.target.tagName==="TR"){e=t.target}else if(t.target.tagName==="TD"){e=t.target.parentNode}if(e&&r.has(e)){r.show(e)}});(function t(){if(k.readyState===WebSocket.OPEN&&Date.now()-g>resetTimeout){console.log("Receive timeout. Resetting connection.");k.refresh()}const e=~~(6e4+Math.random()*42e3);setTimeout(t,e)})();
