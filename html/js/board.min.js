import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";import{ActivityIcon as t}from"./activity_icon.min.js";import{StatsBox as o}from"./statsbox.min.js";import{InfoBox as a}from"./infobox.min.js";import{distance3 as m,trimPrefix as l,makeTd as u,addRow as f,whatGame as n}from"./utils.min.js";const k=new t(window.icon,idleTimeout),i=new a(document.body,window.infotemplate.content.children[0]),p=new o(window.statsbody,{Total:0,Old:0,New:0,Ignored:0,Taxi:0,Base:0,Horizons:0,Odyssey:0,Legacy:0,Unknown:0,TS:"","Max jump range":""});let h=0;class v{data;gameType;timestamp;event;isTaxi;isOld;isNew;constructor(e){this.data=e,this.gameType=n(e),e=e.message,this.timestamp=e.timestamp,this.event=e.event,this.isTaxi=!!e.taxi,e=new Date-new Date(e.timestamp),this.isOld=36e5<e,this.isNew=e<-18e4}}function T(e){var t=document.createElement("tr");return t.classList.add("data"),t.classList.add(e.gameType),e.isTaxi&&t.classList.add("taxi"),e.isOld?t.classList.add("old"):e.isNew&&t.classList.add("new"),i.set(t,e.data),t}let y=Date.now();const s=new e(socketUrl);s.onopen=k.idle,s.onclose=k.off,s.onmessage=e=>{let t={};try{t=JSON.parse(e.data)}catch(e){return console.log("JSON parse error:",e),void k.error()}var o=t.message;if(o){k.ok(),y=Date.now(),p.inc("Total");var a,n=new v(t);if(p.inc(n.gameType),p.set("TS",n.timestamp),n.isTaxi&&p.inc("Taxi"),n.isOld?p.inc("Old"):n.isNew&&p.inc("New"),n.event)switch(p.inc(n.event),n.event){case"Scan":(a=T(n)).append(u(o.BodyName),u(o.ScanType)),f(window.scanbods,a),!1===o.WasDiscovered&&"NavBeaconDetail"!==o.ScanType&&(o.StarType?((a=T(n)).append(u(o.BodyName),u(o.StarType+" "+o.Subclass)),f(window.newstars,a)):o.PlanetClass&&((a=T(n)).append(u(o.BodyName),u(o.PlanetClass),u(o.AtmosphereType&&"None"!==o.AtmosphereType?o.AtmosphereType:""),u(o.Landable?"Yes":"")),f(window.newplanets,a)));break;case"FSDJump":(a=T(n)).append(u(o.StarSystem)),f(window.jumps,a),(0<o.Population||o.SystemAllegiance)&&(a=T(n),w=o.SystemFaction||{},a.append(u(o.StarSystem),u(1e9<=o.Population?(o.Population/1e9).toFixed(2)+"G":1e6<=o.Population?(o.Population/1e6).toFixed(2)+"M":1e3<=o.Population?(o.Population/1e3).toFixed(2)+"k":0<o.Population?(+o.Population).toFixed(2):""),u(o.SystemAllegiance),u(w.Name||""),u(w.FactionState||"")),f(window.visits,a));break;case"NavRoute":var i,s,r=T(n),c=o.Route||[];if(1<c.length){r.append(u(c[0].StarSystem),u(c[c.length-1].StarSystem),u(c.length-1+"j"));let e=0,t=0,o;for(const d of c)o?(i=d.StarPos,s=m(o,i),h<s&&(h=s,p.set("Max jump range",s.toFixed(2)+"ly")),t<s&&(t=s),e+=s,o=i):(o=d.StarPos,r.append(u(m(o,c[c.length-1].StarPos).toFixed(2)+"ly")));r.append(u(2<c.length?e.toFixed(2)+"ly":""));var w=u(t.toFixed(2)+"ly");200<=t&&w.classList.add("longjump"),r.append(w),f(window.routes,r)}else console.log("Short NavRoute:",t);break;case"Docked":case"Location":(a=T(n)).append(u(o.StationName||""),u(o.StationType||""),u(o.StarSystem)),f(window.docks,a);break;case"ApproachSettlement":(w=T(n)).append(u(o.Name),u(o.StarSystem)),f(window.asett,w);break;case"CodexEntry":(a=T(n)).append(u(o.System),u(l(o.BodyName||"",o.System)),u(o.SubCategory),u(o.Name)),f(window.codex,a);break;default:p.inc("Ignored")}else(e=T(n)).append(u(o.commodities?"Market":o.ships?"Shipyard":o.modules?"Outfitting":""),u(o.stationName),u(o.systemName)),f(window.updates,e)}else console.log("No message: ",t),k.error()},window.board.addEventListener("click",e=>{let t;"TR"===e.target.tagName?t=e.target:"TD"===e.target.tagName&&(t=e.target.parentNode),t&&i.has(t)&&i.show(t)}),function e(){s.readyState===WebSocket.OPEN&&Date.now()-y>resetTimeout&&(console.log("Receive timeout. Resetting connection."),s.refresh());var t=~~(6e4+42e3*Math.random());setTimeout(e,t)}();
