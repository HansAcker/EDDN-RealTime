import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";import{ActivityIcon as t}from"./activity_icon.min.js";import{StatsBox as o}from"./statsbox.min.js";import{InfoBox as n}from"./infobox.min.js";import{distance3 as u,trimPrefix as p,makeTd as f,addRow as k,whatGame as a}from"./utils.min.js";const v=new t(window.icon,idleTimeout),i=new n(document.body,window.infotemplate.content.children[0]),h=new o(window.softbody),y=new o(window.eventsbody),g=new o(window.statsbody,{Total:0,Odyssey:0,Horizons:0,Base:0,Legacy:0,Unknown:0,Taxi:0,Old:0,New:0,Ignored:0,"Last timestamp":"","Max jump range":""});let x=0;class T{data;gameType;timestamp;event;isTaxi;isOld;isNew;constructor(e){this.data=e,this.gameType=a(e),e=e.message,this.timestamp=e.timestamp,this.event=e.event,this.isTaxi=!!e.Taxi,e=new Date-new Date(e.timestamp),this.isOld=36e5<e,this.isNew=e<-18e4}}function b(e){var t=document.createElement("tr");return t.classList.add("data"),t.classList.add(e.gameType),e.isTaxi&&t.classList.add("taxi"),e.isOld?t.classList.add("old"):e.isNew&&t.classList.add("new"),i.set(t,e.data),t}let N=Date.now();const s=new e(socketUrl);s.onopen=v.idle,s.onclose=v.off,s.onmessage=e=>{let t={};try{t=JSON.parse(e.data)}catch(e){return console.log("JSON parse error:",e),void v.error()}var o=t.message;if(o){v.ok(),N=Date.now(),g.inc("Total");var n=new T(t);g.inc(n.gameType),g.set("Last timestamp",n.timestamp);var a,i=(e=window.softbody).childElementCount;if(h.inc(t.header.softwareName+" "+t.header.softwareVersion),e.childElementCount!=i&&e.replaceChildren(...[...e.children].sort((e,t)=>e.children[0].textContent<t.children[0].textContent?1:-1)),n.isTaxi&&g.inc("Taxi"),n.isOld?g.inc("Old"):n.isNew&&g.inc("New"),n.event){y.inc(n.event);{const m=[...(i=window.eventsbody).children];(e=[...m].sort((e,t)=>parseInt(t.children[1].textContent)-parseInt(e.children[1].textContent))).every((e,t)=>e===m[t])||i.replaceChildren(...e)}switch(n.event){case"Scan":(a=b(n)).append(f(o.BodyName),f(o.ScanType)),k(window.scanbods,a),!1===o.WasDiscovered&&"NavBeaconDetail"!==o.ScanType&&(o.StarType?((a=b(n)).append(f(o.BodyName),f(o.StarType+" "+o.Subclass)),k(window.newstars,a)):o.PlanetClass&&((a=b(n)).append(f(o.BodyName),f(o.PlanetClass),f(o.AtmosphereType&&"None"!==o.AtmosphereType?o.AtmosphereType:""),f(o.Landable?"Yes":"")),k(window.newplanets,a)));break;case"FSDJump":(a=b(n)).append(f(o.StarSystem)),k(window.jumps,a),(0<o.Population||o.SystemAllegiance)&&(a=b(n),d=o.SystemFaction||{},a.append(f(o.StarSystem),f(1e9<=o.Population?(o.Population/1e9).toFixed(2)+"G":1e6<=o.Population?(o.Population/1e6).toFixed(2)+"M":1e3<=o.Population?(o.Population/1e3).toFixed(2)+"k":0<o.Population?(+o.Population).toFixed(2):""),f(o.SystemAllegiance),f(d.Name||""),f(d.FactionState||"")),k(window.visits,a));break;case"NavRoute":var s=o.Route||[];if(1<s.length){var r,w,c=b(n);c.append(f(s[0].StarSystem),f(s[s.length-1].StarSystem),f(s.length-1+"j"));let e=0,t=0,o;for(const l of s)o?(r=l.StarPos,w=u(o,r),x<w&&(x=w,g.set("Max jump range",w.toFixed(2)+"ly")),t<w&&(t=w),e+=w,o=r):(o=l.StarPos,c.append(f(u(o,s[s.length-1].StarPos).toFixed(2)+"ly")));c.append(f(2<s.length?e.toFixed(2)+"ly":""));var d=f(t.toFixed(2)+"ly");200<=t&&d.classList.add("longjump"),c.append(d),k(window.routes,c)}else console.log("Short NavRoute:",t);break;case"Docked":case"Location":(a=b(n)).append(f(o.StationName||""),f(o.StationType||""),f(o.StarSystem)),k(window.docks,a);break;case"ApproachSettlement":(d=b(n)).append(f(o.Name),f(o.StarSystem)),k(window.asett,d);break;case"CodexEntry":(a=b(n)).append(f(o.System),f(p(o.BodyName||"",o.System)),f(o.SubCategory),f(o.Name)),k(window.codex,a);break;default:g.inc("Ignored")}}else(i=b(n)).append(f(o.commodities?"Market":o.ships?"Shipyard":o.modules?"Outfitting":""),f(o.stationName),f(o.systemName)),k(window.updates,i)}else console.log("No message:",t),v.error()},window.board.addEventListener("click",e=>{let t;"TR"===e.target.tagName?t=e.target:"TD"===e.target.tagName&&(t=e.target.parentNode),t&&i.has(t)&&i.show(t)}),function e(){s.readyState===WebSocket.OPEN&&Date.now()-N>resetTimeout&&(console.log("Receive timeout. Resetting connection."),s.refresh());var t=~~(6e4+42e3*Math.random());setTimeout(e,t)}();
