import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";const m=(e,t)=>Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2]),h=e=>{var t=document.createElement("td");return t.textContent=e,t};function y(e,t){for(;20<=e.children.length;)e.removeChild(e.lastChild);e.insertBefore(t,e.firstChild)}const C={Total:0,Old:0,New:0,Ignored:0,Taxi:0,Base:0,Horizons:0,Odyssey:0,Unknown:0,TS:"","Max jump range":""};let u=statstable.querySelector("tbody"),S=0,v=Date.now();const n={ok:"img/led-circle-green.svg",off:"img/led-circle-red.svg",idle:"img/led-circle-grey.svg",error:"img/led-circle-yellow.svg"};let a=null,d="off";const o=()=>{d="idle",icon.href=n.idle,a=null};function g(e,t=0){a&&(clearTimeout(a),a=null),d!=e&&(console.log(d+" => "+e),icon.href=n[e],d=e),t&&(a=setTimeout(o,t))}const l=new e("wss://ws.eddn-realtime.space/eddn");l.onopen=g.bind(null,"idle",0),l.onclose=g.bind(null,"off",0),l.onmessage=e=>{g("ok",1600);let t={};try{t=JSON.parse(e.data)}catch(e){return console.log("JSON parse error:",e),void g("error")}C.Total++,v=Date.now();e=t.message;if(e){var n=(n=e).odyssey?"Odyssey":n.horizons?"Horizons":!1===n.horizons?"Base":"Unknown",a=(C[n]++,document.createElement("tr"));a.classList.add(n),e.Taxi&&(C.Taxi++,a.classList.add("taxi")),C.TS=e.timestamp;try{var d=new Date-new Date(e.timestamp);36e5<d?(a.classList.add("old"),C.Old++,e.isOld=!0):d<-18e4&&(a.classList.add("new"),C.New++)}catch(e){}if(e.event)if(e.event in C||(C[e.event]=0),C[e.event]++,"Scan"===e.event&&"NavBeaconDetail"!==e.ScanType&&!1===e.WasDiscovered)a.appendChild(h(e.BodyName)),a.appendChild(h(e.ScanType)),y(newbods,a),e.StarType?((n=document.createElement("tr")).appendChild(h(e.BodyName)),n.appendChild(h(e.StarType+" "+e.Subclass)),y(newstars,n)):e.PlanetClass&&((d=document.createElement("tr")).appendChild(h(e.BodyName)),d.appendChild(h(e.PlanetClass)),d.appendChild(h(""+(e.AtmosphereType&&"None"!==e.AtmosphereType?e.AtmosphereType:""))),d.appendChild(h(e.Landable?"Yes":"")),y(newplanets,d));else if("Scan"!==e.event||"NavBeaconDetail"!==e.ScanType&&!1===e.WasDiscovered)if("FSDJump"===e.event)a.appendChild(h(e.StarSystem)),y(jumps,a),(0<e.Population||e.SystemAllegiance)&&((n=document.createElement("tr")).appendChild(h(e.StarSystem)),n.appendChild(h(""+(1e9<=e.Population?(e.Population/1e9).toFixed(2)+"G":1e6<=e.Population?(e.Population/1e6).toFixed(2)+"M":1e3<=e.Population?(e.Population/1e3).toFixed(2)+"k":0<e.Population?(+e.Population).toFixed(2):""))),n.appendChild(h(e.SystemAllegiance)),d=e.SystemFaction||{},n.appendChild(h(""+(d.Name||""))),n.appendChild(h(""+(d.FactionState||""))),y(visits,n));else if("FSSDiscoveryScan"===e.event)a.appendChild(h(e.SystemName)),a.appendChild(h(e.BodyCount)),a.appendChild(h(e.NonBodyCount)),y(honks,a);else if("Docked"===e.event||"Location"===e.event)a.appendChild(h(""+(e.StationName||""))),a.appendChild(h(e.StarSystem)),y(docks,a);else if("NavRoute"===e.event){var d=e.Route;if(1<d.length){a.appendChild(h(d[0].StarSystem)),a.appendChild(h(d[d.length-1].StarSystem)),a.appendChild(h(d.length-1+"j"));try{let e=0,t=0,n=d.shift().StarPos;a.appendChild(h(m(n,d[d.length-1].StarPos).toFixed(2)+"ly"));for(const r of d){var o=r.StarPos,l=m(n,o);S<l&&(S=l,C["Max jump range"]=l.toFixed(2)+"ly"),t<l&&(t=l),e+=l,n=o}a.appendChild(h(1<d.length?e.toFixed(2)+"ly":""));var i=h(t.toFixed(2)+"ly");200<=t&&i.classList.add("longjump"),a.appendChild(i)}catch(e){}y(routes,a)}}else"ApproachSettlement"===e.event?(a.appendChild(h(e.Name)),a.appendChild(h(e.StarSystem)),y(asett,a)):"CodexEntry"===e.event?(a.appendChild(h(e.System)),a.appendChild(h((n=e.BodyName||"",d=e.System,(n.startsWith(d)?n.slice(d.length):n).trim()))),a.appendChild(h(e.SubCategory)),a.appendChild(h(e.Name)),y(codex,a)):C.Ignored++;else a.appendChild(h(e.BodyName)),a.appendChild(h(e.ScanType)),y(oldbods,a);else a.appendChild(h(e.commodities?"Market":e.ships?"Shipyard":e.modules?"Outfitting":"")),a.appendChild(h(e.stationName||"")),a.appendChild(h(e.systemName||"")),y(updates,a);if(!document.hidden){var s=document.createElement("tbody");for(const c in C){var p=document.createElement("tr");p.appendChild(h(c)),p.appendChild(h(C[c])),s.appendChild(p)}statstable.replaceChild(s,u),u=s}}},function e(){l.readyState===WebSocket.OPEN&&3e5<Date.now()-v&&(console.log("Receive timeout. Resetting connection."),l.refresh());var t=~~(6e4+23e3*Math.random());setTimeout(e,t)}();
