import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";import{ActivityIcon as t}from"./activity_icon.min.js";import{StatsBox as o}from"./statsbox.min.js";const c=(e,t)=>Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2]),d=e=>{var t=document.createElement("td");return t.textContent=t.title=e,t};function m(e,t){for(;e.childElementCount>=listLength;)e.lastElementChild.remove();e.prepend(t)}const p=new o(statstable.querySelector("tbody"),{Total:0,Old:0,New:0,Ignored:0,Taxi:0,Base:0,Horizons:0,Odyssey:0,Legacy:0,Unknown:0,TS:"","Max jump range":""});let y=0,S=Date.now();const a=new e(socketUrl),u=new t(icon,idleTimeout);a.onopen=u.idle,a.onclose=u.off,a.onmessage=e=>{let t={};try{t=JSON.parse(e.data)}catch(e){return console.log("JSON parse error:",e),void u.error()}if(e=t.message){u.ok(),S=Date.now(),p.inc("Total");var a=function(e){try{var t,o=e.header.gameversion;return o&&(o.startsWith("CAPI-Legacy-")||parseInt(o)<4)?"Legacy":(t=e.message).odyssey?"Odyssey":t.horizons?"Horizons":!1===t.horizons?"Base":"Unknown"}catch(e){return console.log("gameversion error:",e),"Unknown"}}(t),n=(p.inc(a),document.createElement("tr"));n.classList.add(a),e.Taxi&&(p.inc("Taxi"),n.classList.add("taxi")),p.set("TS",e.timestamp);try{36e5<(o=new Date-new Date(e.timestamp))?(n.classList.add("old"),p.inc("Old")):o<-18e4&&(n.classList.add("new"),p.inc("New"))}catch(e){console.log("Invalid date:",e)}if(e.event)if(p.inc(e.event),"Scan"===e.event){if(n.append(d(e.BodyName),d(e.ScanType)),m(scanbods,n),!1===e.WasDiscovered&&"NavBeaconDetail"!==e.ScanType)if(e.StarType){const n=document.createElement("tr");n.classList.add(a),n.append(d(e.BodyName),d(e.StarType+" "+e.Subclass)),m(newstars,n)}else if(e.PlanetClass){const n=document.createElement("tr");n.classList.add(a),n.append(d(e.BodyName),d(e.PlanetClass),d(e.AtmosphereType&&"None"!==e.AtmosphereType?e.AtmosphereType:""),d(e.Landable?"Yes":"")),m(newplanets,n)}}else if("FSDJump"===e.event){if(n.append(d(e.StarSystem)),m(jumps,n),0<e.Population||e.SystemAllegiance){const n=document.createElement("tr");n.classList.add(a);var o=e.SystemFaction||{};n.append(d(e.StarSystem),d(1e9<=e.Population?(e.Population/1e9).toFixed(2)+"G":1e6<=e.Population?(e.Population/1e6).toFixed(2)+"M":1e3<=e.Population?(e.Population/1e3).toFixed(2)+"k":0<e.Population?(+e.Population).toFixed(2):""),d(e.SystemAllegiance),d(o.Name||""),d(o.FactionState||"")),m(visits,n)}}else if("NavRoute"===e.event)if(1<(a=e.Route||[]).length){n.append(d(a[0].StarSystem),d(a[a.length-1].StarSystem),d(a.length-1+"j"));try{let e=0,t=0,o=a.shift().StarPos;n.append(d(c(o,a[a.length-1].StarPos).toFixed(2)+"ly"));for(const l of a){var s=l.StarPos,i=c(o,s);y<i&&(y=i,p.set("Max jump range",i.toFixed(2)+"ly")),t<i&&(t=i),e+=i,o=s}n.append(d(1<a.length?e.toFixed(2)+"ly":""));var r=d(t.toFixed(2)+"ly");200<=t&&r.classList.add("longjump"),n.append(r)}catch(e){console.log("Error in route:",e)}m(routes,n)}else console.log("Short NavRoute:",t);else"Docked"===e.event||"Location"===e.event?(n.append(d(e.StationName||""),d(e.StationType||""),d(e.StarSystem)),m(docks,n)):"ApproachSettlement"===e.event?(n.append(d(e.Name),d(e.StarSystem)),m(asett,n)):"CodexEntry"===e.event?(n.append(d(e.System),d((o=e.BodyName||"",a=e.System,(o.startsWith(a)?o.slice(a.length):o).trim())),d(e.SubCategory),d(e.Name)),m(codex,n)):p.inc("Ignored");else n.append(d(e.commodities?"Market":e.ships?"Shipyard":e.modules?"Outfitting":""),d(e.stationName),d(e.systemName)),m(updates,n)}else console.log("No message: ",t),u.error()},function e(){a.readyState===WebSocket.OPEN&&Date.now()-S>resetTimeout&&(console.log("Receive timeout. Resetting connection."),a.refresh());var t=~~(6e4+42e3*Math.random());setTimeout(e,t)}();
