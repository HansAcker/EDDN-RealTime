import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";import{PageIconActivity as t}from"./activity_icon.min.js";import{StatsBox as o,SortedStatsBox as n}from"./statsbox.min.js";import{InfoBox as i}from"./infobox.min.js";import{distance3 as $,trimPrefix as _,makeTd as p,addRow as h,whatGame as s,GalacticRegions as k}from"./utils.min.js";const g=new t(window.icon,idleTimeout);const c=new i(document.body,window.infotemplate.content.children[0]);const y=new o(window.softbody);const b=new n(window.eventsbody);const x=new o(window.statsbody,{Total:0,Odyssey:0,Horizons:0,Base:0,Legacy:0,Unknown:0,Taxi:0,Multicrew:0,Old:0,New:0,Ignored:0,"Last timestamp":"","Max jump range":""});let N=0;class T{t;o;i;l;m;u;$;_;constructor(e){this.t=e;this.o=s(e);const t=e.message;this.i=t.timestamp;this.l=t.event;this.m=!!t.Taxi;this.u=!!t.Multicrew;const o=new Date-new Date(t.timestamp);this.$=o>3600*1e3;this._=o<-180*1e3}}function j(e){const t=document.createElement("tr");t.classList.add("data");t.classList.add(e.o);if(e.m){t.classList.add("taxi")}if(e.u){t.classList.add("multicrew")}if(e.$){t.classList.add("old")}else if(e._){t.classList.add("new")}c.set(t,e.t);return t}let D=Date.now();const a=new e(socketUrl);a.onopen=g.idle;a.onclose=g.off;a.onmessage=e=>{let t;try{t=JSON.parse(e.data);if(!(t.$schemaRef&&t.header&&t.message)){console.log("Invalid message:",t);g.error();return}}catch(e){console.log("JSON object error:",e);g.error();return}const o=t.$schemaRef;const n=t.header;const i=t.message;g.ok();D=Date.now();x.inc("Total");const s=new T(t);x.inc(s.o);x.set("Last timestamp",s.i);{const c=window.softbody;const a=c.childElementCount;y.inc(`${n.softwareName} ${n.softwareVersion}`);if(c.childElementCount!=a){c.replaceChildren(...[...c.children].sort((e,t)=>e.children[0].textContent<t.children[0].textContent?1:-1))}}if(s.m){x.inc("Taxi")}if(s.u){x.inc("Multicrew")}if(s.$){x.inc("Old")}else if(s._){x.inc("New")}if(s.l){b.inc(s.l);switch(s.l){case"Scan":{const w=j(s);w.append(p(i.BodyName),p(i.ScanType));h(window.scanbods,w);if(i.WasDiscovered===false&&i.WasMapped===false&&i.ScanType!=="NavBeaconDetail"){if(i.StarType){const w=j(s);w.append(p(i.BodyName),p(`${i.StarType} ${i.Subclass}`));h(window.newstars,w)}else if(i.PlanetClass){const w=j(s);w.append(p(i.BodyName),p(i.PlanetClass),p(i.AtmosphereType&&i.AtmosphereType!=="None"?i.AtmosphereType:""),p(i.Landable?"Yes":""));h(window.newplanets,w)}}break}case"FSDJump":{const w=j(s);w.append(p(i.StarSystem));h(window.jumps,w);if(i.Population>0||i.SystemAllegiance){const w=j(s);const r=i.SystemFaction||{};w.append(p(i.StarSystem),p(i.Population>=1e9?(i.Population/1e9).toFixed(2)+"G":i.Population>=1e6?(i.Population/1e6).toFixed(2)+"M":i.Population>=1e3?(i.Population/1e3).toFixed(2)+"k":i.Population>0?(i.Population/1).toFixed(2):""),p(i.SystemAllegiance),p(r.Name||""),p(r.FactionState||""));h(window.visits,w)}break}case"NavRoute":{const l=i.Route||[];if(l.length>1){const w=j(s);w.append(p(l[0].StarSystem),p(l[l.length-1].StarSystem),p(`${l.length-1}j`));let e=0;let t=0;let o;for(const d of l){if(!o){o=d.StarPos;w.append(p(`${$(o,l[l.length-1].StarPos).toFixed(2)}ly`));continue}const m=d.StarPos;const u=$(o,m);if(N<u){N=u;x.set("Max jump range",`${u.toFixed(2)}ly`)}if(t<u){t=u}e+=u;o=m}w.append(p(l.length>2?`${e.toFixed(2)}ly`:""));const f=p(`${t.toFixed(2)}ly`);if(t>=200){f.classList.add("longjump")}w.append(f);h(window.routes,w)}else{console.log("Short NavRoute:",t)}break}case"Docked":case"Location":{const w=j(s);w.append(p(i.StationName||""),p(i.StationType||""),p(i.StarSystem));h(window.docks,w);break}case"ApproachSettlement":{const w=j(s);w.append(p(i.Name),p(i.StarSystem));h(window.asett,w);break}case"CodexEntry":{const w=j(s);w.append(p(i.System),p(_(i.BodyName||"",i.System)),p(i.SubCategory.replace(/^\$Codex_SubCategory_(.*);$/,"$1").replaceAll("_"," ")),p(i.Name.replace(/^\$Codex_Ent_(.*)_Name;$/,"$1").replaceAll("_"," ")),p(k[i.Region.replace(/^\$Codex_RegionName_(.*);$/,"$1")]));h(window.codex,w);break}default:x.inc("Ignored")}}else{const w=j(s);w.append(p(i.commodities?"Market":i.ships?"Shipyard":i.modules?"Outfitting":""),p(i.stationName),p(i.systemName));h(window.updates,w)}};window.board.addEventListener("click",e=>{let t;if(e.target.tagName==="TR"){t=e.target}else if(e.target.tagName==="TD"){t=e.target.parentNode}if(t&&c.has(t)){c.show(t)}});(function e(){if(a.readyState===WebSocket.OPEN&&Date.now()-D>resetTimeout){console.log("Receive timeout. Resetting connection.");a.refresh()}const t=~~(6e4+Math.random()*42e3);setTimeout(e,t)})();
