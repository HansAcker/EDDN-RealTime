import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";import*as c from"./activity.min.js";const d=(e,t)=>Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2]),m=e=>{var t=document.createElement("td");return t.textContent=t.title=e,t};function p(e,t){for(;e.childElementCount>=listLength;)e.lastElementChild.remove();e.prepend(t)}const y={Total:0,Old:0,New:0,Ignored:0,Taxi:0,Base:0,Horizons:0,Odyssey:0,Legacy:0,Unknown:0,TS:"","Max jump range":""};let u=0,o=statstable.querySelector("tbody"),S;function g(){var e=document.createElement("tbody");for(const a in y){var t=document.createElement("tr");t.append(m(a),m(""+y[a])),e.append(t)}o.replaceWith(e),o=e}let h=Date.now();const a=new e(socketUrl);a.onopen=c.idle,a.onclose=c.off,a.onmessage=e=>{let t={};try{t=JSON.parse(e.data)}catch(e){return console.log("JSON parse error:",e),void c.error()}if(e=t.message){c.ok(idleTimeout),h=Date.now(),y.Total++;var o=function(e){try{var t,a=e.header.gameversion;return a&&(a.startsWith("CAPI-Legacy-")||parseInt(a)<4)?"Legacy":(t=e.message).odyssey?"Odyssey":t.horizons?"Horizons":!1===t.horizons?"Base":"Unknown"}catch(e){return console.log("gameversion error:",e),"Unknown"}}(t),n=(y[o]++,document.createElement("tr"));n.classList.add(o),e.Taxi&&(y.Taxi++,n.classList.add("taxi")),y.TS=e.timestamp;try{36e5<(a=new Date-new Date(e.timestamp))?(n.classList.add("old"),y.Old++):a<-18e4&&(n.classList.add("new"),y.New++)}catch(e){console.log("Invalid date:",e)}if(e.event)if(e.event in y||(y[e.event]=0),y[e.event]++,"Scan"===e.event){if(n.append(m(e.BodyName),m(e.ScanType)),p(scanbods,n),!1===e.WasDiscovered&&"NavBeaconDetail"!==e.ScanType)if(e.StarType){const n=document.createElement("tr");n.classList.add(o),n.append(m(e.BodyName),m(e.StarType+" "+e.Subclass)),p(newstars,n)}else if(e.PlanetClass){const n=document.createElement("tr");n.classList.add(o),n.append(m(e.BodyName),m(e.PlanetClass),m(e.AtmosphereType&&"None"!==e.AtmosphereType?e.AtmosphereType:""),m(e.Landable?"Yes":"")),p(newplanets,n)}}else if("FSDJump"===e.event){if(n.append(m(e.StarSystem)),p(jumps,n),0<e.Population||e.SystemAllegiance){const n=document.createElement("tr");n.classList.add(o);var a=e.SystemFaction||{};n.append(m(e.StarSystem),m(1e9<=e.Population?(e.Population/1e9).toFixed(2)+"G":1e6<=e.Population?(e.Population/1e6).toFixed(2)+"M":1e3<=e.Population?(e.Population/1e3).toFixed(2)+"k":0<e.Population?(+e.Population).toFixed(2):""),m(e.SystemAllegiance),m(a.Name||""),m(a.FactionState||"")),p(visits,n)}}else if("NavRoute"===e.event)if(1<(o=e.Route||[]).length){n.append(m(o[0].StarSystem),m(o[o.length-1].StarSystem),m(o.length-1+"j"));try{let e=0,t=0,a=o.shift().StarPos;n.append(m(d(a,o[o.length-1].StarPos).toFixed(2)+"ly"));for(const l of o){var s=l.StarPos,r=d(a,s);u<r&&(u=r,y["Max jump range"]=r.toFixed(2)+"ly"),t<r&&(t=r),e+=r,a=s}n.append(m(1<o.length?e.toFixed(2)+"ly":""));var i=m(t.toFixed(2)+"ly");200<=t&&i.classList.add("longjump"),n.append(i)}catch(e){console.log("Error in route:",e)}p(routes,n)}else console.log("Short NavRoute:",t);else"Docked"===e.event||"Location"===e.event?(n.append(m(e.StationName||""),m(e.StationType||""),m(e.StarSystem)),p(docks,n)):"ApproachSettlement"===e.event?(n.append(m(e.Name),m(e.StarSystem)),p(asett,n)):"CodexEntry"===e.event?(n.append(m(e.System),m((a=e.BodyName||"",o=e.System,(a.startsWith(o)?a.slice(o.length):a).trim())),m(e.SubCategory),m(e.Name)),p(codex,n)):y.Ignored++;else n.append(m(e.commodities?"Market":e.ships?"Shipyard":e.modules?"Outfitting":""),m(e.stationName),m(e.systemName)),p(updates,n);document.hidden||(cancelAnimationFrame(S),S=requestAnimationFrame(g))}else console.log("No message: ",t),c.error()},function e(){a.readyState===WebSocket.OPEN&&Date.now()-h>resetTimeout&&(console.log("Receive timeout. Resetting connection."),a.refresh());var t=~~(6e4+42e3*Math.random());setTimeout(e,t)}();
