import{ReconnectingWebSocket as e}from"./reconnecting-websocket.min.js";import{PageIconActivity as t}from"./activity_icon.min.js";import{StatsBox as o,SortedStatsBox as a}from"./statsbox.min.js";import{InfoBox as i}from"./infobox.min.js";import{distance3 as u,trimPrefix as _,makeTd as f,addRow as g,whatGame as n,GalacticRegions as x}from"./utils.min.js";const k=new t(window.icon,idleTimeout),s=new i(document.body,window.infotemplate.content.children[0]),p=new o(window.softbody),v=new a(window.eventsbody),h=new o(window.statsbody,{Total:0,Odyssey:0,Horizons:0,Base:0,Legacy:0,Unknown:0,Taxi:0,Multicrew:0,Old:0,New:0,Ignored:0,"Last timestamp":"","Max jump range":""});let y=0;class b{t;o;i;m;l;u;_;g;constructor(e){this.t=e,this.o=n(e),e=e.message,this.i=e.timestamp,this.m=e.event,this.l=!!e.Taxi,this.u=!!e.Multicrew,e=new Date-new Date(e.timestamp),this._=36e5<e,this.g=e<-18e4}}function S(e){var t=document.createElement("tr");return t.classList.add("data"),t.classList.add(e.o),e.l&&t.classList.add("taxi"),e.u&&t.classList.add("multicrew"),e._?t.classList.add("old"):e.g&&t.classList.add("new"),s.set(t,e.t),t}let T=Date.now();const r=new e(socketUrl);r.onopen=k.idle,r.onclose=k.off,r.onmessage=e=>{let t;try{if(!((t=JSON.parse(e.data)).$schemaRef&&t.header&&t.message))return console.log("Invalid message:",t),void k.error()}catch(e){return console.log("JSON object error:",e),void k.error()}t.$schemaRef;var o,e=t.header,a=t.message,i=(k.ok(),T=Date.now(),h.inc("Total"),new b(t)),n=(h.inc(i.o),h.set("Last timestamp",i.i),window.softbody),s=n.childElementCount;if(p.inc(e.softwareName+" "+e.softwareVersion),n.childElementCount!=s&&n.replaceChildren(...[...n.children].sort((e,t)=>e.children[0].textContent<t.children[0].textContent?1:-1)),i.l&&h.inc("Taxi"),i.u&&h.inc("Multicrew"),i._?h.inc("Old"):i.g&&h.inc("New"),i.m)switch(v.inc(i.m),i.m){case"Scan":(o=S(i)).append(f(a.BodyName),f(a.ScanType)),g(window.scanbods,o),!1===a.WasDiscovered&&!1===a.WasMapped&&"NavBeaconDetail"!==a.ScanType&&(a.StarType?((o=S(i)).append(f(a.BodyName),f(a.StarType+" "+a.Subclass)),g(window.newstars,o)):a.PlanetClass&&((o=S(i)).append(f(a.BodyName),f(a.PlanetClass),f(a.AtmosphereType&&"None"!==a.AtmosphereType?a.AtmosphereType:""),f(a.Landable?"Yes":"")),g(window.newplanets,o)));break;case"FSDJump":(o=S(i)).append(f(a.StarSystem)),g(window.jumps,o),(0<a.Population||a.SystemAllegiance)&&(o=S(i),m=a.SystemFaction||{},o.append(f(a.StarSystem),f(1e9<=a.Population?(a.Population/1e9).toFixed(2)+"G":1e6<=a.Population?(a.Population/1e6).toFixed(2)+"M":1e3<=a.Population?(a.Population/1e3).toFixed(2)+"k":0<a.Population?(+a.Population).toFixed(2):""),f(a.SystemAllegiance),f(m.Name||""),f(m.FactionState||"")),g(window.visits,o));break;case"NavRoute":var r=a.Route||[];if(1<r.length){var w,c,d=S(i);d.append(f(r[0].StarSystem),f(r[r.length-1].StarSystem),f(r.length-1+"j"));let e=0,t=0,o;for(const l of r)o?(w=l.StarPos,c=u(o,w),y<c&&(y=c,h.set("Max jump range",c.toFixed(2)+"ly")),t<c&&(t=c),e+=c,o=w):(o=l.StarPos,d.append(f(u(o,r[r.length-1].StarPos).toFixed(2)+"ly")));d.append(f(2<r.length?e.toFixed(2)+"ly":""));var m=f(t.toFixed(2)+"ly");200<=t&&m.classList.add("longjump"),d.append(m),g(window.routes,d)}else console.log("Short NavRoute:",t);break;case"Docked":case"Location":(o=S(i)).append(f(a.StationName||""),f(a.StationType||""),f(a.StarSystem)),g(window.docks,o);break;case"ApproachSettlement":(m=S(i)).append(f(a.Name),f(a.StarSystem)),g(window.asett,m);break;case"CodexEntry":(o=S(i)).append(f(a.System),f(_(a.BodyName||"",a.System)),f(a.Category.replace(/^\$Codex_Category_(.*);$/,"$1").replaceAll("_"," ")+" / "+a.SubCategory.replace(/^\$Codex_SubCategory_(.*);$/,"$1").replaceAll("_"," ")),f(a.Name.replace(/^\$Codex_Ent_(.*)_Name;$/,"$1").replaceAll("_"," ")),f(x[a.Region.replace(/^\$Codex_RegionName_(.*);$/,"$1")])),g(window.codex,o);break;default:h.inc("Ignored")}else(e=S(i)).append(f(a.commodities?"Market":a.ships?"Shipyard":a.modules?"Outfitting":""),f(a.stationName),f(a.systemName)),g(window.updates,e)},window.board.addEventListener("click",e=>{let t;"TR"===e.target.tagName?t=e.target:"TD"===e.target.tagName&&(t=e.target.parentNode),t&&s.has(t)&&s.show(t)}),function e(){r.readyState===WebSocket.OPEN&&Date.now()-T>resetTimeout&&(console.log("Receive timeout. Resetting connection."),r.refresh());var t=~~(6e4+42e3*Math.random());setTimeout(e,t)}();
